<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Adult Social Learning</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" />
</head>
<body></body>
<script>
// Get subject_id and sona_id from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const sona_id = urlParams.get('sona_id');

// Initialize jsPsych
const jsPsych = initJsPsych({
  on_finish: () => {
    //window.location.assign(
    //  "https://ucsd.sona-systems.com/webstudy_credit.aspx?" +
    //  "experiment_id=3034" +
    //  "&credit_token=01a78e4314674941a686cb385df7a34b" +
    //  "&survey_code=" + sona_id
    //);
    jsPsych.data.get().localSave('csv', 'test_data.csv');
  }
});

// Generate a participant ID
//const participantID = jsPsych.randomization.randomID(10);

// Add participant ID to EVERY trial's data
//jsPsych.data.addProperties({
//  ID: participantID
//});

    // -------------------------------
    // Helpers
    // -------------------------------
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    function getBaseName(path){ return path.split('/').pop(); }

/* -------------------------------
   1. S stimuli
--------------------------------*/
const baseUrl = 'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/';

const Simages = [
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S1.png',
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S2.png',
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S3.png',
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S4.png'
];

// 14 explicit C patterns — set reps for each pattern individually
const S_patterns = [
 { stims: ['S1.png'],                        reps: 6 },
 { stims: ['S1.png', 'S2.png'],              reps: 5 },
 { stims: ['S1.png', 'S3.png'],              reps: 3 },
 { stims: ['S1.png', 'S4.png'],              reps: 3 },
 { stims: ['S2.png', 'S4.png'],              reps: 3 },
 { stims: ['S3.png', 'S4.png'],              reps: 5 },
 { stims: ['S4.png'],                        reps: 6 },
 { stims: ['S1.png', 'S2.png', 'S4.png'],    reps: 2 },
 { stims: ['S1.png', 'S3.png', 'S4.png'],    reps: 2 },
 { stims: ['S2.png'],                        reps: 4 },
 { stims: ['S3.png'],                        reps: 4 },
 { stims: ['S2.png', 'S3.png'],              reps: 3 },
 { stims: ['S1.png', 'S2.png', 'S3.png'],    reps: 2 },
 { stims: ['S2.png', 'S3.png', 'S4.png'],    reps: 2 },
];


// Resolve filenames to full URLs (reps carried through)
const S_pairs = S_patterns.map(pattern => ({
  stims: pattern.stims.map(f => baseUrl + f),
  reps: pattern.reps
}));

/* -------------------------------
   2. O stimuli
--------------------------------*/
const O1 = ['O1.png'].map(f => `https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/${f}`);
const O2 = ['O2.png'].map(f => `https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/${f}`);

const O_groups = [O1, O2];

// Generate all possible cross-group O pairs
const O_pairs = [];
for (let i = 0; i < O_groups.length - 1; i++) {
  for (let j = i + 1; j < O_groups.length; j++) {
    const groupA = O_groups[i];
    const groupB = O_groups[j];
    for (let a = 0; a < groupA.length; a++) {
      for (let b = 0; b < groupB.length; b++) {
        O_pairs.push({ stim1: groupA[a], stim2: groupB[b] });
      }
    }
  }
}

/* -------------------------------
   3. S->O probability table
--------------------------------*/
const S_O_probabilities = {
  'S1.png': {'O1.png':0.80,'O2.png':0.20},
  'S2.png': {'O1.png':0.40,'O2.png':0.60},
  'S3.png': {'O1.png':0.60,'O2.png':0.40},
  'S4.png': {'O1.png':0.20,'O2.png':0.80}
};

/* -------------------------------
   4. C/nO stimuli
--------------------------------*/
const Cimages = [
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C1.png',
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C2.png',
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C3.png',
  'https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C4.png'
];

/* -------------------------------
   4. C/nO stimuli
--------------------------------*/



// 14 explicit C patterns — set reps for each pattern individually
const C_patterns = [
 { stims: ['C1.png'],                        reps: 6 },
 { stims: ['C1.png', 'C2.png'],              reps: 5 },
 { stims: ['C1.png', 'C3.png'],              reps: 3 },
 { stims: ['C1.png', 'C4.png'],              reps: 3 },
 { stims: ['C2.png', 'C4.png'],              reps: 3 },
 { stims: ['C3.png', 'C4.png'],              reps: 5 },
 { stims: ['C4.png'],                        reps: 6 },
 { stims: ['C1.png', 'C2.png', 'C4.png'],    reps: 2 },
 { stims: ['C1.png', 'C3.png', 'C4.png'],    reps: 2 },
 { stims: ['C2.png'],                        reps: 4 },
 { stims: ['C3.png'],                        reps: 4 },
 { stims: ['C2.png', 'C3.png'],              reps: 3 },
 { stims: ['C1.png', 'C2.png', 'C3.png'],    reps: 2 },
 { stims: ['C2.png', 'C3.png', 'C4.png'],    reps: 2 },
];


// Resolve filenames to full URLs (reps carried through)
const C_pairs = C_patterns.map(pattern => ({
  stims: pattern.stims.map(f => baseUrl + f),
  reps: pattern.reps
}));

const nO1 = ['nO1.png'].map(f => `${baseUrl}${f}`);
const nO2 = ['nO2.png'].map(f => `${baseUrl}${f}`);

const nO_groups = [nO1, nO2];
const nO_pairs = [];
for (let i = 0; i < nO_groups.length - 1; i++) {
  for (let j = i + 1; j < nO_groups.length; j++) {
    const groupA = nO_groups[i];
    const groupB = nO_groups[j];
    for (let a = 0; a < groupA.length; a++) {
      for (let b = 0; b < groupB.length; b++) {
        nO_pairs.push({ stim1: groupA[a], stim2: groupB[b] });
      }
    }
  }
}

/* -------------------------------
   5. C->nO probability table
--------------------------------*/
const C_nO_probabilities = {
  'C1.png': { 'nO1.png': .20, 'nO2.png': .80 },
  'C2.png': { 'nO1.png': .40, 'nO2.png': .60 },
  'C3.png': { 'nO1.png': .60, 'nO2.png': .40 },
  'C4.png': { 'nO1.png': .80, 'nO2.png': .20 }
};

/* -------------------------------
   6. Preload images
--------------------------------*/
const preloadImages = Array.from(new Set([...Simages,...O_groups.flat(),...Cimages,...nO_groups.flat()]));
const timeline = [];
timeline.push({ type: jsPsychPreload, images: preloadImages });

// Consent form
var consent = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus:`<div style="text-align: left; max-width: 800px; margin: 0 auto;">
              <h3>Exempt Information Sheet</h3>
              <p>You are being invited to participate in a research study titled Adult Social Implicit Learning. This study is being done by Leslie Carver and Wilder Hartwell from UC San Diego. You were selected to participate in this study because you are a UCSD student 18 years or older.</p>
              <p>The purpose of this research study is to obtain greater knowledge about social and nonsocial implicit learning. Your participation in this research should last approximately 1.5 hours. If you agree to take part in this study, you will be asked to complete a task on the computer that will take approximately 1.5 hours. The task will involve predicting the outcome of cues.</p>
              <p>Your participation in this study is completely voluntary and you can withdraw at any time. Choosing not to participate or withdrawing will result in no penalty or loss of benefits to which you are entitled. You are free to skip any question that you choose.</p>
              <p>If you have questions about this project or if you have a research-related problem, you may contact the researcher, Leslie Carver, 858-757-4513. If you have any questions concerning your rights as a research subject, you may contact the UC San Diego Office of IRB Administration at irb@ucsd.edu or 858-246-4777.</p>
              <p>By participating in this research you are indicating that you are at least 18 years old, have read this consent form, and agree to participate in this research study. Please keep this consent form for your records.</p>
              <p>If you agree to participate, press the enter key to continue. If you no longer want to participate, please close the webpage.</p>
              </div>`,
 post_trial_gap: 1000,
 choices: ['Enter']
};
timeline.push(consent);

// Welcome screen
var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<h2>Welcome to the experiment!</h2>
               <p>Press the enter key to begin.</p>`,
    post_trial_gap: 1000,
    choices: ['Enter']

};
timeline.push(welcome);


// Demographic questions 
var demographics = {
    type: jsPsychSurveyMultiChoice,
    preamble: `<p><h3>Please answer the following demographic questions. Your answers will not affect your ability to participate.</h3></p>`,
    questions: [
      {
        prompt: "What is your age?",
        name: "age",
        options: ["18-24", "25-34", "35-44", "45-54", "55-64", "65+", "Prefer not to say"],
        required: true
      },
      {
        prompt: "What is your gender?",
        name: "gender",
        options: ["Man", "Woman", "Genderqueer", "Prefer not to say"],
        required: true
      },
      {
        prompt: "What is your race?",
        name: "race",
        options: ["White", "Black or African American", "Asian", "Hispanic or Latino", "Native American or Alaska Native", "Native Hawaiian or Other Pacific Islander", "Mixed Race", "Other", "Prefer not to say"],
        required: true
      }
    ]}
timeline.push(demographics);



// Instructions for survey
var SRS_instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<p><h3>One more step before you begin the experiment task: please answer this short survey with how true each statement is for you.</h3></p>
               <p>Press the enter key to continue.</p>`,
    post_trial_gap: 1000,
    choices: ['Enter']
};
timeline.push(SRS_instructions);

// Shortened Social Responsiveness Scale (SRS) - Adult Self Report
// 4, 7, 8, 13,16, 18, 22, 23, 29, 30, 33, 37, 38, 39, 42, and 54
const SRS = {
  type: jsPsychSurveyMultiChoice,
  preamble: `<p>How true is the following statement for you?</p>`,
  questions: [  
    { name: 'SRS1', prompt: "When under stress, I engage in rigid or inflexible patterns of behavior that seem odd to people.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true },
    { name: 'SRS2', prompt: "I am usually aware of how others are feeling.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS3', prompt: "I behave in ways that seem strange or bizarre to others.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS4', prompt: "I am awkward in turn-taking interactions with others (for example, I have a hard time keeping up with the give-and-take of a conversation).", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS5', prompt: "I avoid eye contact or am told that I have unusal eye contact.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS6', prompt: "I have sensory interests that others find unusual (for example, smelling or looking at things in a special way).", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS7', prompt: "I interact appropriately with other adults.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS8', prompt: "I do not join group activities or social events unless prompted or strongly urged to do so.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS9', prompt: "I am regarded by others as odd or weird.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS10', prompt: "I become upset in situations with lots of things going on.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS11', prompt: "My behavior is socially awkward, even when I am trying to be polite.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS12', prompt: "I have difficulty relating to adults outside of my family.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS13', prompt: "I respond appropriately to mood changes in others (for example, when a friend's mood changes from happy to sad).", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS14', prompt: "People think I am interested in too few topics, or that I get too carried away with those topics.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS15', prompt: "I am overly sensitive to certain sounds, textures, or smells.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  },
    { name: 'SRS16', prompt: "I tend to think about people in the same way that I do objects.", options: ['Almost Always True', 'Often True', 'Sometimes True', 'Not True'], required: true  }
  ],
  }
timeline.push(SRS);
/* -------------------------------
   Instructions for experiment
--------------------------------*/
var social_instructions ={
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `<p style="margin-left: 30px; margin-right: 30px;">In this task you're going to learn to predict the behavior of the character in the <b>blue shirt</b> 
             based on the behavior of the character in the <b>red shirt</b>. <b>A</b> and <b>L</b> are positioned below the two
             response choices. Press <b>A</b> or <b>L</b> to indicate which response you think blue shirt is most likely to have (crying or shock)
             given red shirt's actions. The correct answer may not align with what response you would expect blue shirt to have
             in real life. You will receive feedback after every trial and use that feedback to improve your performance. It's
             ok if sometimes you feel like you're guessing. You will complete four sections of these trials and you will have short
             breaks in between.</p>
             <p>In addition to this task you're going to be shown four random numbers before every trial. Remember them, because after the trial you will be shown another number
             and asked to indicate (A = no, L = yes) whether that number was in the original set of four numbers. Please try your best even though you will <b>not</b> recieve feedback on your performance.</p>
             <p> Both of these tasks move quickly, so do your best to answer accurately and quickly. </p>
             <p>Press the enter key to begin.</p>`,
  choices: ['Enter'],
  post_trial_gap: 2000};

  var nonsocial_instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<p style="margin-left: 30px; margin-right: 30px;">In this task you're going to learn to predict the weather based on cue cards. <b>A</b> and <b>L</b> are 
                positioned below the two response choices. Press <b>A</b> or <b>L</b> to indicate which weather outcome 
                (sunny or rainy) you think is most likely given the cue cards. The cue cards don't reference any real life 
                weather predictors. You will receive feedback after every trial and use that feedback to improve your performance. 
                It's ok if sometimes you feel like you're guessing. You will complete four sections of these trials and you will 
                have short breaks in between.</p>
                <p>In addition to this task you're going to be shown four random numbers before every trial. Remember them, because after the trial you will be shown another number
                and asked to indicate (A = no, L = yes) whether that number was in the original set of four numbers. Please try your best even though you will <b>not</b> recieve feedback on your performance.</p>
                <p> Both of these tasks move quickly, so do your best to answer accurately and quickly. </p>
               <p>Press the enter key to begin</p>`,
    post_trial_gap: 2000,
    choices: ['Enter']
  };
/* ============================================================
   Build S/O block timeline and C/nO block timeline
============================================================ */
// -------------------------------------------------------
// Helper: generate one digit sequence + probe for S/O trials
// Returns an object with:
//   digits        — array of 4 unique digits (1-9)
//   probe         — the digit shown at probe time
//   probe_in_list — boolean, whether probe was in the sequence
// -------------------------------------------------------
function generateDigitInfo() {
  // Build pool of digits 1-9, shuffle, take first 6
  const pool = [1,2,3,4,5,6,7,8,9];
  shuffle(pool);
  const digits = pool.slice(0, 6);

  // 50/50: probe is either one of the 6 digits shown, or one of the 3 NOT shown
  const probeInList = Math.random() < 0.5;
  let probe;
  if (probeInList) {
    probe = digits[Math.floor(Math.random() * digits.length)];
  } else {
    const notShown = pool.slice(6); // remaining 3 digits not in the sequence
    probe = notShown[Math.floor(Math.random() * notShown.length)];
  }

  return { digits, probe, probe_in_list: probeInList };
}

// --- S/O BLOCK ---
let SO_block = [];

let S_repeated = [];
S_pairs.forEach(pattern => {
  for (let r = 0; r < pattern.reps; r++) {
    S_repeated.push({ stims: pattern.stims });
  }
});
shuffle(S_repeated);

let O_trials = [];
O_pairs.forEach(p => O_trials.push({ ...p }));
while (O_trials.length < S_repeated.length) {
  O_trials.push(O_pairs[Math.floor(Math.random()*O_pairs.length)]);
}
shuffle(O_trials);

for (let i = 0; i < S_repeated.length; i++) {
  const S_pattern = S_repeated[i];
  const Opair = O_trials[i];

  const O1_base = Opair.stim1.split('/').pop();
  const O2_base = Opair.stim2.split('/').pop();

  const allSCards = ['S1.png', 'S2.png', 'S3.png', 'S4.png'];
  const presentCards = S_pattern.stims.map(src => src.split('/').pop());

  let raw_p1 = 1;
  let raw_p2 = 1;
  for (const card of allSCards) {
    if (presentCards.includes(card)) {
      raw_p1 *= S_O_probabilities[card][O1_base];
      raw_p2 *= S_O_probabilities[card][O2_base];
    } else {
      raw_p1 *= (1 - S_O_probabilities[card][O1_base]);
      raw_p2 *= (1 - S_O_probabilities[card][O2_base]);
    }
  }

  const total = raw_p1 + raw_p2;
  const p1 = raw_p1 / total;
  const p2 = raw_p2 / total;

  const correct_answer = p1 >= p2 ? 'a' : 'l';
  const sampled_outcome = Math.random() < p1 ? 'a' : 'l';

  // Generate digit span info for this trial
  const digitInfo = generateDigitInfo();

  SO_block.push({
    timeline: [

      // 1. DIGIT SEQUENCE — shown for 1200ms, no response required
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;justify-content:center;align-items:center;gap:50px;margin-top:80px;">
            ${digitInfo.digits.map(d =>
              `<span style="font-size:72px;font-weight:bold;">${d}</span>`
            ).join('')}
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 1200,
        post_trial_gap: 500,
        data: {
          task: 'digit_sequence',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        }
      },

      // 2. S/O COMBINED DISPLAY + RESPONSE
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;flex-direction:column;align-items:center;gap:40px;">

            <div style="display:flex;justify-content:center;gap:60px;">
              ${S_pattern.stims.map(src =>
                `<img src="${src}" style="width:300px;height:auto;">`
              ).join('')}
            </div>

            <div style="
              width:80%;
              height:3px;
              background-color:#444;
              margin:10px 0;
            "></div>

            <div style="display:flex;justify-content:center;gap:60px;">
              <img src="${Opair.stim1}" style="width:220px;height:auto;">
              <img src="${Opair.stim2}" style="width:220px;height:auto;">
            </div>

          </div>

          <p style="margin-top:15px; word-spacing:265px; font-size:28px;">
            <b>A</b> <b>L</b>
          </p>
        `,
        choices: ['a','l'],
        trial_duration: 2000,
        data: {
          task: 'S_O_train',
          pattern: S_pattern.stims,
          stim1: Opair.stim1,
          stim2: Opair.stim2,
          correct_answer: correct_answer,
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          data.correct = data.response === correct_answer.toLowerCase();
          data.feedback_correct = data.response === sampled_outcome;
        }
      },

      // 3. S/O FEEDBACK
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function(){
          const last = jsPsych.data.get().last(1).values()[0];
          return last.feedback_correct ?
            '<p style="color:green;font-size:32px;">CORRECT</p>' :
            '<p style="color:red;font-size:32px;">INCORRECT</p>';
        },
        choices: "NO_KEYS",
        trial_duration: 1000,
        post_trial_gap: 500
      },

      // 4. DIGIT PROBE — was this digit in the sequence? (A = yes, L = no)
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="text-align:center;margin-top:60px;">
            <p style="font-size:22px;margin-bottom:40px;">Was this digit in the sequence?</p>
            <p><span style="font-size:96px;font-weight:bold;">${digitInfo.probe}</span></p>
            <p style="font-size:18px;color:#555;margin-top:30px;">(A = No &nbsp;&nbsp;&nbsp; L = Yes)</p>
          </div>
        `,
        choices: ['a', 'l'],
        trial_duration: 2000,
        post_trial_gap: 1000,
        data: {
          task: 'digit_probe',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list,
          // correct answer: 'l' if probe was in the list, 'a' if not
          correct_answer_digit: digitInfo.probe_in_list ? 'l' : 'a'
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          const correct_digit_answer = digitInfo.probe_in_list ? 'l' : 'a';
          data.correct_digit = data.response === correct_digit_answer;
        }
      },
    ]
  });
}

// --- Test Block Instructions ---
var test_instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<p style="margin-left: 30px; margin-right: 30px;">In this section of the experiment, you will no longer receive feedback.
               Everything else remains the same.</p>
               <p>Press the enter to begin.</p>`,
    post_trial_gap: 2000,
    choices: ['Enter']
  };

// --- S/O TEST BLOCK ---
let SO_test_block = [];

// Expand S pairs
let S_test_repeated = [];
S_pairs.forEach(pattern => {
  for (let r = 0; r < pattern.reps; r++) {
    S_test_repeated.push({ stims: pattern.stims });
  }
});
shuffle(S_test_repeated);

let O_test_trials = [];
O_pairs.forEach(p => O_test_trials.push({ ...p }));
while (O_test_trials.length < S_test_repeated.length) {
  O_test_trials.push(O_pairs[Math.floor(Math.random()*O_pairs.length)]);
}
shuffle(O_test_trials);
for (let i = 0; i < S_test_repeated.length; i++) {
  const S_pattern = S_test_repeated[i];
  const Opair = O_test_trials[i];

  const O1_base = Opair.stim1.split('/').pop();
  const O2_base = Opair.stim2.split('/').pop();

  // All four possible S cards
  const allSCards = ['S1.png', 'S2.png', 'S3.png', 'S4.png'];
  
  // Which cards are present in this pattern
  const presentCards = S_pattern.stims.map(src => src.split('/').pop());

  // Naive Bayes: multiply probabilities for present cards,
  // multiply (1 - probability) for absent cards
  let raw_p1 = 1;
  let raw_p2 = 1;
  for (const card of allSCards) {
    if (presentCards.includes(card)) {
      // Card is present — multiply by its probability
      raw_p1 *= S_O_probabilities[card][O1_base];
      raw_p2 *= S_O_probabilities[card][O2_base];
    } else {
      // Card is absent — multiply by 1 minus its probability
      raw_p1 *= (1 - S_O_probabilities[card][O1_base]);
      raw_p2 *= (1 - S_O_probabilities[card][O2_base]);
    }
  }

  // Normalize so both sum to 1
  const total = raw_p1 + raw_p2;
  const p1 = raw_p1 / total;
  const p2 = raw_p2 / total;

  const correct_answer = p1 >= p2 ? 'a' : 'l';

  // Generate digit span info for test trials too
  const digitInfo = generateDigitInfo();

  SO_test_block.push({
    timeline: [

      // 1. DIGIT SEQUENCE
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;justify-content:center;align-items:center;gap:50px;margin-top:80px;">
            ${digitInfo.digits.map(d =>
              `<span style="font-size:72px;font-weight:bold;">${d}</span>`
            ).join('')}
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 1200,
        post_trial_gap: 500,
        data: {
          task: 'digit_sequence_test',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        }
      },

      // 2. S/O TRIAL (no feedback)
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;flex-direction:column;align-items:center;gap:40px;">

            <div style="display:flex;justify-content:center;gap:60px;">
              ${S_pattern.stims.map(src =>
                `<img src="${src}" style="width:300px;height:auto;">`
              ).join('')}
            </div>

            <div style="
              width:80%;
              height:3px;
              background-color:#444;
              margin:10px 0;
            "></div>

            <div style="display:flex;justify-content:center;gap:60px;">
              <img src="${Opair.stim1}" style="width:220px;height:auto;">
              <img src="${Opair.stim2}" style="width:220px;height:auto;">
            </div>

          </div>

          <p style="margin-top:15px; word-spacing:265px; font-size:28px;">
            <b>A</b> <b>L</b>
          </p>
        `,
        choices: ['a', 'l'],
        trial_duration: 2000,
        post_trial_gap: 500,
        data: {
          task: 'S_O_test',
          pattern: S_pattern.stims,
          stim1: Opair.stim1,
          stim2: Opair.stim2,
          correct_answer: correct_answer,
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          data.correct = data.response === correct_answer.toLowerCase();
        }
      },

      // 3. DIGIT PROBE (no S/O feedback in test block, but digit probe remains)
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="text-align:center;margin-top:60px;">
            <p style="font-size:22px;margin-bottom:40px;">Was this digit in the sequence?</p>
            <span style="font-size:96px;font-weight:bold;">${digitInfo.probe}</span>
            <p style="font-size:18px;color:#555;margin-top:30px">(A = No &nbsp;&nbsp;&nbsp; L = Yes)</p>
          </div>
        `,
        choices: ['a', 'l'],
        trial_duration: 2000,
        post_trial_gap: 1000,
        data: {
          task: 'digit_probe_test',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list,
          correct_answer_digit: digitInfo.probe_in_list ? 'l' : 'a'
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          const correct_digit_answer = digitInfo.probe_in_list ? 'l' : 'a';
          data.correct_digit = data.response === correct_digit_answer;
        }
      },
    ]
  });
}

// --- C/nO BLOCK ---
let CnO_block = [];

let C_repeated = [];
C_pairs.forEach(pattern => {
  for (let r = 0; r < pattern.reps; r++) {
    C_repeated.push({ stims: pattern.stims });
  }
});
shuffle(C_repeated);

let nO_trials = [];
nO_pairs.forEach(p => nO_trials.push({ ...p }));
while (nO_trials.length < C_repeated.length) {
  nO_trials.push(nO_pairs[Math.floor(Math.random()*nO_pairs.length)]);
}
shuffle(nO_trials);
for (let i = 0; i < C_repeated.length; i++) {
  const C_pattern = C_repeated[i];
  const nOpair = nO_trials[i];

  const nO1_base = nOpair.stim1.split('/').pop();
  const nO2_base = nOpair.stim2.split('/').pop();

  // All four possible C cards
  const allCCards = ['C1.png', 'C2.png', 'C3.png', 'C4.png'];
  
  // Which cards are present in this pattern
  const presentCards = C_pattern.stims.map(src => src.split('/').pop());

  // Naive Bayes: multiply probabilities for present cards,
  // multiply (1 - probability) for absent cards
  let raw_p1 = 1;
  let raw_p2 = 1;
  for (const card of allCCards) {
    if (presentCards.includes(card)) {
      // Card is present — multiply by its probability
      raw_p1 *= C_nO_probabilities[card][nO1_base];
      raw_p2 *= C_nO_probabilities[card][nO2_base];
    } else {
      // Card is absent — multiply by 1 minus its probability
      raw_p1 *= (1 - C_nO_probabilities[card][nO1_base]);
      raw_p2 *= (1 - C_nO_probabilities[card][nO2_base]);
    }
  }

  // Normalize so both sum to 1
  const total = raw_p1 + raw_p2;
  const p1 = raw_p1 / total;
  const p2 = raw_p2 / total;

// The statistically correct answer based on which nO is most probable
  const correct_answer = p1 >= p2 ? 'a' : 'l';

  // Probabilistically sample which outcome actually occurs this trial.
  // If random number < p1, nO1 "happens" (feedback answer = 'a'), 
  // otherwise nO2 "happens" (feedback answer = 'l').
  // This means feedback will say CORRECT 80% of the time when the
  // participant picks the higher-probability nO, and INCORRECT 20% of the time.
  const sampled_outcome = Math.random() < p1 ? 'a' : 'l';

  const digitInfo = generateDigitInfo();

  CnO_block.push({
    timeline: [
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;justify-content:center;align-items:center;gap:50px;margin-top:80px;">
            ${digitInfo.digits.map(d =>
              `<span style="font-size:72px;font-weight:bold;">${d}</span>`
            ).join('')}
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 1200,
        post_trial_gap: 500,
        data: {
          task: 'digit_sequence',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        }
      },

      // 2. C/nO TRIAL
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;flex-direction:column;align-items:center;gap:40px;">

            <div style="display:flex;justify-content:center;gap:60px;">
              ${C_pattern.stims.map(src =>
                `<img src="${src}" style="width:300px;height:auto;">`
              ).join('')}
            </div>

            <div style="
              width:80%;
              height:3px;
              background-color:#444;
              margin:10px 0;
            "></div>

            <div style="display:flex;justify-content:center;gap:60px;">
              <img src="${nOpair.stim1}" style="width:220px;height:auto;">
              <img src="${nOpair.stim2}" style="width:220px;height:auto;">
            </div>

          </div>

          <p style="margin-top:15px; word-spacing:265px; font-size:28px;">
            <b>A</b> <b>L</b>
          </p>
        `,
        choices: ['a','l'],
        trial_duration: 2000,
        data: {
          task: 'C_nO_train',
          pattern: C_pattern.stims,
          stim1: nOpair.stim1,
          stim2: nOpair.stim2,
          correct_answer: correct_answer,
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          data.correct = data.response === correct_answer.toLowerCase();
          data.feedback_correct = data.response === sampled_outcome;
        }
      },

      // 3. C/nO FEEDBACK
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function(){
          const last = jsPsych.data.get().last(1).values()[0];
          return last.feedback_correct ?
            '<p style="color:green;font-size:32px;">CORRECT</p>' :
            '<p style="color:red;font-size:32px;">INCORRECT</p>';
        },
        choices: "NO_KEYS",
        trial_duration: 1000,
        post_trial_gap: 500
      },

      // 4. DIGIT PROBE
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="text-align:center;margin-top:60px;">
            <p style="font-size:22px;margin-bottom:40px;">Was this digit in the sequence?</p>
            <span style="font-size:96px;font-weight:bold;">${digitInfo.probe}</span>
            <p style="font-size:18px;color:#555;margin-top:30px">(A = No &nbsp;&nbsp;&nbsp; L = Yes)</p>
          </div>
        `,
        choices: ['a', 'l'],
        trial_duration: 2000,
        post_trial_gap: 1000,
        data: {
          task: 'digit_probe',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list,
          correct_answer_digit: digitInfo.probe_in_list ? 'l' : 'a'
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          const correct_digit_answer = digitInfo.probe_in_list ? 'l' : 'a';
          data.correct_digit = data.response === correct_digit_answer;
        }
      },
    ]
  });
}

// --- C/nO TEST BLOCK ---
let CnO_test_block = [];

let C_test_repeated = [];
C_pairs.forEach(pattern => {
  for (let r = 0; r < pattern.reps; r++) {
    C_test_repeated.push({ stims: pattern.stims });
  }
});
shuffle(C_test_repeated);

let nO_test_trials = [];
nO_pairs.forEach(p => nO_test_trials.push({ ...p }));
while (nO_test_trials.length < C_test_repeated.length) {
  nO_test_trials.push(nO_pairs[Math.floor(Math.random()*nO_pairs.length)]);
}
shuffle(nO_test_trials);
for (let i = 0; i < C_test_repeated.length; i++) {
  const C_pattern = C_test_repeated[i];
  const nOpair = nO_test_trials[i];

  const nO1_base = nOpair.stim1.split('/').pop();
  const nO2_base = nOpair.stim2.split('/').pop();

  // All four possible C cards
  const allCCards = ['C1.png', 'C2.png', 'C3.png', 'C4.png'];
  
  // Which cards are present in this pattern
  const presentCards = C_pattern.stims.map(src => src.split('/').pop());

  // Naive Bayes: multiply probabilities for present cards,
  // multiply (1 - probability) for absent cards
  let raw_p1 = 1;
  let raw_p2 = 1;
  for (const card of allCCards) {
    if (presentCards.includes(card)) {
      // Card is present — multiply by its probability
      raw_p1 *= C_nO_probabilities[card][nO1_base];
      raw_p2 *= C_nO_probabilities[card][nO2_base];
    } else {
      // Card is absent — multiply by 1 minus its probability
      raw_p1 *= (1 - C_nO_probabilities[card][nO1_base]);
      raw_p2 *= (1 - C_nO_probabilities[card][nO2_base]);
    }
  }

  // Normalize so both sum to 1
  const total = raw_p1 + raw_p2;
  const p1 = raw_p1 / total;
  const p2 = raw_p2 / total;

  const correct_answer = p1 >= p2 ? 'a' : 'l';

  const digitInfo = generateDigitInfo();

  CnO_test_block.push({
    timeline: [
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;justify-content:center;align-items:center;gap:50px;margin-top:80px;">
            ${digitInfo.digits.map(d =>
              `<span style="font-size:72px;font-weight:bold;">${d}</span>`
            ).join('')}
          </div>
        `,
        choices: "NO_KEYS",
        trial_duration: 1200,
        post_trial_gap: 500,
        data: {
          task: 'digit_sequence',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        }
      },

      // 2. C/nO test TRIAL
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="display:flex;flex-direction:column;align-items:center;gap:40px;">

            <div style="display:flex;justify-content:center;gap:60px;">
              ${C_pattern.stims.map(src =>
                `<img src="${src}" style="width:300px;height:auto;">`
              ).join('')}
            </div>

            <div style="
              width:80%;
              height:3px;
              background-color:#444;
              margin:10px 0;
            "></div>

            <div style="display:flex;justify-content:center;gap:60px;">
              <img src="${nOpair.stim1}" style="width:220px;height:auto;">
              <img src="${nOpair.stim2}" style="width:220px;height:auto;">
            </div>

          </div>

          <p style="margin-top:15px; word-spacing:265px; font-size:28px;">
            <b>A</b> <b>L</b>
          </p>
        `,
        choices: ['a','l'],
        trial_duration: 2000,
        post_trial_gap: 500,
        data: {
          task: 'C_nO_test',
          pattern: C_pattern.stims,
          stim1: nOpair.stim1,
          stim2: nOpair.stim2,
          correct_answer: correct_answer,
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          data.correct = data.response === correct_answer.toLowerCase();
        }
      },

      // 4. DIGIT PROBE
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="text-align:center;margin-top:60px;">
            <p style="font-size:22px;margin-bottom:40px;">Was this digit in the sequence?</p>
            <span style="font-size:96px;font-weight:bold;">${digitInfo.probe}</span>
            <p style="font-size:18px;color:#555;margin-top:30px">(A = No &nbsp;&nbsp;&nbsp; L = Yes)</p>
          </div>
        `,
        choices: ['a', 'l'],
        trial_duration: 2000,
        post_trial_gap: 1000,
        data: {
          task: 'digit_probe',
          digit_sequence: digitInfo.digits,
          digit_probe: digitInfo.probe,
          digit_probe_in_list: digitInfo.probe_in_list,
          correct_answer_digit: digitInfo.probe_in_list ? 'l' : 'a'
        },
        on_finish: data => {
          if (data.response) {
            if (typeof data.response === 'number') {
              data.response = jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.response);
            }
            if (typeof data.response === 'string') {
              data.response = data.response.toLowerCase();
            }
          }
          const correct_digit_answer = digitInfo.probe_in_list ? 'l' : 'a';
          data.correct_digit = data.response === correct_digit_answer;
        }
      },

    ]
  });
}

var break_trial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<p>Good job! You can take a short break now.</p>
              <p>We know sometimes it's hard when you're not receiving feedback, 
              but please try to do your best to respond accurately on both parts of the task.</p> 
              <p>Press the enter key when you are ready to continue.</p>`,
    post_trial_gap: 1000,
    choices: ['Enter']
};

/* ============================================================
   TRUE 50/50 COUNTERBALANCING ACROSS PARTICIPANTS
============================================================ */
// Deterministic 50/50 assignment
let socialFirst;

if (sona_id) {
  // Simple hash: sum of character codes
  let hash = 0;
  for (let i = 0; i < sona_id.length; i++) {
    hash += sona_id.charCodeAt(i);
  }
  socialFirst = (hash % 2 === 0);
} else {
  // Fallback if no sona_id
  socialFirst = (Math.random() < 0.5);
}

jsPsych.data.addProperties({
  ID: sona_id,
  socialFirst: socialFirst
});

console.log("sona_id =", sona_id);
console.log("socialFirst =", socialFirst);

/* ============================================================
   Add blocks to actual timeline in chosen order
============================================================ */

if (socialFirst) {
  timeline.push(social_instructions);
  timeline.push(...SO_block);
  timeline.push(break_trial);
  timeline.push(...SO_block);
  timeline.push(break_trial);
  timeline.push(...SO_block);
  timeline.push(break_trial);
  timeline.push(test_instructions);
  timeline.push({timeline: SO_test_block});
  timeline.push({ type: jsPsychHtmlKeyboardResponse, stimulus:"<p><h3>You're halfway done! Please take as long of a break as you need.</h3></p> <p>When you're ready, press the enter key to continue.</p>",choices:['Enter']});
  timeline.push(nonsocial_instructions)
  timeline.push(...CnO_block);
  timeline.push(break_trial);
  timeline.push(...CnO_block);
  timeline.push(break_trial);
  timeline.push(...CnO_block);
  timeline.push(break_trial);
  timeline.push(test_instructions);
  timeline.push(...CnO_test_block);
} else {
  timeline.push(nonsocial_instructions);
  timeline.push(...CnO_block);
  timeline.push(break_trial);
  timeline.push(...CnO_block);
  timeline.push(break_trial);
  timeline.push(...CnO_block);
  timeline.push(break_trial);
  timeline.push(test_instructions);
  timeline.push(...CnO_test_block);
  timeline.push({ type: jsPsychHtmlKeyboardResponse, stimulus:"<p><h3>You're halfway done! Please take as long of a break as you need.</h3></p> <p>When you're ready, press the enter key to continue.</p>", choices: ['Enter']});
  timeline.push(social_instructions);
  timeline.push(...SO_block);
  timeline.push(break_trial);
  timeline.push(...SO_block);
  timeline.push(break_trial);
  timeline.push(...SO_block);
  timeline.push(break_trial);
  timeline.push(test_instructions);
  timeline.push({timeline: SO_test_block});
}

// POST SURVEY
// Social post survey questions defined
var post_survey_social = [
  {
    prompt: `<p>Given what red shirt is doing here, what action is blue shirt most likely to do?</p>
    <p><i>(Select <b>1</b>)</i></p>
    <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S1.png" style="width:250px;"></p>`,
    name: "Post_S1",
    options: [
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O1.png" style="width:250px;">',
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O2.png" style="width:250px;">'
    ],
    required: true
  },
  {
    prompt: `<p>Given what red shirt is doing here, what action is blue shirt most likely to do?</p>
    <p><i>(Select <b>1</b>)</i></p>
    <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S2.png" style="width:250px;"></p>`,
    name: "Post_S2",
    options: [
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O1.png" style="width:250px;">',
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O2.png" style="width:250px;">'
    ],
    required: true
  },
  {
    prompt: `<p>Given what red shirt is doing here, what action is blue shirt most likely to do?</p>
    <p><i>(Select <b>1</b>)</i></p>
    <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S3.png" style="width:250px;"></p>`,
    name: "Post_S3",
    options: [
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O1.png" style="width:250px;">',
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O2.png" style="width:250px;">'
    ],
    required: true
  },
  {
    prompt: `<p>Given what red shirt is doing here, what action is blue shirt most likely to do?</p>
    <p><i>(Select <b>1</b>)</i></p>
    <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/S4.png" style="width:250px;"></p>`,
    name: "Post_S4",
    options: [
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O1.png" style="width:250px;">',
      '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/O2.png" style="width:250px;">'
    ],
    required: true
  }
];

var post_survey_social_trials = post_survey_social.map((q, i) => ({
  type: jsPsychSurveyMultiSelect,
  preamble: "<p>Think back on everything you've done in the experiment and answer the following questions.</p>",
  questions: [ q ],
  data: { question_index: i+1 },
  validation_function: function(response) {
    const selected = response[q.name];
    if (!selected || selected.length === 0) {
      return "Please select an answer.";
    }
    if (selected.length > 1) {
      return "Please select only 1 answer.";
    }
    return true;
  },
  on_finish: function(data) {
    let resp = data.responses;
    if (typeof resp === 'string') {
      try { resp = JSON.parse(resp); } catch(e) { resp = {}; }
    }
    const val = resp && resp[q.name] ? resp[q.name][0] : null;
    data[q.name] = val;
  }
}));


// Nonsocial post survey questions defined
var post_survey_nonsocial = [
    {
      prompt: `<p>Given the pattern on the card presented here, which weather outcome is most likely to happen?</p>
      <p><i>(Select <b>1</b>)</i></p>
      <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C1.png" style="width:250px;"></p>`,
      name: "Post_C1",
      options: [
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO1.png" style="width:250px;">',
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO2.png" style="width:250px;">'
      ],
      required: true
    },
    {
      prompt: `<p>Given the pattern on the card presented here, which weather outcome is most likely to happen?</p>
      <p><i>(Select <b>1</b>)</i></p>
      <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C2.png" style="width:250px;"></p>`,
      name: "Post_C2",
      options: [
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO1.png" style="width:250px;">',
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO2.png" style="width:250px;">'
      ],
      required: true
    },
    {
      prompt: `<p>Given the pattern on the card presented here, which weather outcome is most likely to happen?</p>
      <p><i>(Select <b>1</b>)</i></p>
      <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C3.png" style="width:250px;"></p>`,
      name: "Post_C3",
      options: [
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO1.png" style="width:250px;">',
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO2.png" style="width:250px;">'
      ],
      required: true
    },
    {
      prompt: `<p>Given the pattern on the card presented here, which weather outcome is most likely to happen?</p>
      <p><i>(Select <b>1</b>)</i></p>
      <p><img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/C4.png" style="width:250px;"></p>`,
      name: "Post_C4",
      options: [
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO1.png" style="width:250px;">',
        '<img src="https://raw.githubusercontent.com/WilderHartwell/SocialNonsocialImplicitLearning/main/stim/nO2.png" style="width:250px;">'
      ],
      required: true
    },
  ];
  // Post survey trials constructed from questions
  var post_survey_nonsocial_trials = post_survey_nonsocial.map((q, i) => ({
    type: jsPsychSurveyMultiSelect,
  preamble: "<p>Think back on everything you've done in the experiment and answer the following questions.</p>",
  questions: [ q ],
  data: { question_index: i+1 },
  validation_function: function(response) {
    const selected = response[q.name];
    if (!selected || selected.length === 0) {
      return "Please select an answer.";
    }
    if (selected.length > 1) {
      return "Please select only 1 answer.";
    }
    return true;
  },
  on_finish: function(data) {
    let resp = data.responses;
    if (typeof resp === 'string') {
      try { resp = JSON.parse(resp); } catch(e) { resp = {}; }
    }
    const val = resp && resp[q.name] ? resp[q.name][0] : null;
    data[q.name] = val;
  }
}));

  // Decide random order for post-surveys and push accordingly
  const postSocialFirst = Math.random() < 0.5;
  // record order choice in data
  jsPsych.data.addProperties({ postSocialFirst });
  if (postSocialFirst) {
    timeline.push(...post_survey_social_trials);
    timeline.push(...post_survey_nonsocial_trials);
  } else {
    timeline.push(...post_survey_nonsocial_trials);
    timeline.push(...post_survey_social_trials);
  }

// DataPipe save data trial
//const save_data = {
//  type: jsPsychPipe,
//  action: "save",
//  experiment_id: "VdvHog1EyUDN",
//  filename: `${sona_id}.csv`,
//  data_string: ()=>jsPsych.data.get().csv()
//};
//timeline.push(save_data);

// Thank you end screen
var end_screen ={
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `<p><h2>Thank you for participating in this study!</h2></p>
             <p>Your SONA credit will be rewarded automatically.</p>
             <p>Press any key to end the experiment.</p>`,
  };
timeline.push(end_screen);
/* -------------------------------
   10. Run experiment
--------------------------------*/
jsPsych.run(timeline);
</script>
</body>
</html>